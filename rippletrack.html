
<body>
<style type="text/css">
  .node circle {
    cursor: pointer;
    fill: #fff;
    stroke: steelblue;
    stroke-width: 1.5px;
  }

  .node text { font: 14px sans-serif; }

  path.link {
    fill: none;
    stroke: #ccc;
    stroke-width: 1.5px;
  }
</style>
<script type="text/javascript" src="d3.v3.min.js"></script>
<script type="text/javascript">
var m_left = 250
var m_top = 20
var w = screen.availWidth - m_left * 2
var h = screen.availHeight - m_top * 2

var svg = d3.select("body")
    .append("svg")
    .attr("width", w + m_left * 2)
    .attr("height", h + m_top * 2)
    .append("svg:g")
    .attr("transform", "translate(" + m_left + "," + m_top + ")");
var tree = d3.layout.tree()
    .size([h,w])
var diagonal = d3.svg.diagonal()
    .projection(function(d) {return [d.y, d.x]})

var data = [{name:"rJYMACXJd1eejwzZA53VncYmiK2kZSBxyD", updated:false}]
var root = data[0]
    root.x0 = h/2
    root.y0 = 0

update(root)

function update(source) {
  var duration = 500
  // Update nodes
  var nodes = tree.nodes(source)
      nodes.forEach(function(d) {d.y = d.depth * m_left})
  
  // Enter any new nodes at the parent's previous position.
  var node = svg.selectAll("g.node")
      .data(nodes)
  var nodeEnter = node.enter()
      .append("svg:g")
      .attr("class", "node")
      .attr("transform", function(d) {return "translate(" + source.y0 + "," + source.x0 + ")"})
      .on("click", function(d) {
        if(d.updated) {toggle(d);update(d)}
        else query(d)})
  nodeEnter.append("circle")
      .attr("r",5)
      .style("fill", function(d) {return d._children ? "lightsteelblue" : "#fff"})
  nodeEnter.append("text")
      .text(function(n) {return n.name})
      .attr("x", function(d) {return d.children || d._children ? -10 : 10})      
      .attr("dy", ".35em")
      .attr("text-anchor", function(d) {return d.children || d._children ? "end" : "start"})
      .attr("fill", "grey")
      .style("fill-opacity", 1e-6)
  nodeEnter.append("text")
      .text(function(n) {return n.value})
      .attr("y", 20)
      .attr("text-anchor", "middle")
      .style("fill-opacity", 1e-6)

  // Transition nodes to their new position.
  var nodeUpdate = node.transition()
      .duration(duration)
      .attr("transform", function(d) {return "translate(" + d.y + "," + d.x + ")"})
  nodeUpdate.select("circle")
      .attr("r", 5)
      .style("fill", function(d) {return d._children ? "lightsteelblue" : "#fff"})
  nodeUpdate.selectAll("text")
      .style("fill-opacity", 1)

   // Transition exiting nodes to the parent's new position.
  var nodeExit = node.exit().transition()
      .duration(duration)
      .attr("transform", function(d) {return "translate(" + source.y + "," + source.x + ")"})
      .remove()
  nodeExit.select("circle")
      .attr("r", 1e-6)
  nodeExit.selectAll("text")
      .style("fill-opacity", 1e-6)

  // Update links
  var links = tree.links(nodes)
  var link = svg.selectAll("path.link")
      .data(links)
  link.enter()
      .insert("path", "g")
      .attr("class", "link")
      .attr("d", function(d) {
        var o = {x: source.x0, y: source.y0}
        return diagonal({source: o, target: o})})
      .transition()
      .duration(duration)
      .attr("d", diagonal)

  // Transition links to their new position.
  link.transition()
      .duration(duration)
      .attr("d", diagonal)

  // Transition exiting nodes to the parent's new position.
  link.exit().transition()
      .duration(duration)
      .attr("d", function(d) {
        var o = {x: source.x, y: source.y}
        return diagonal({source: o, target: o})
      })
      .remove()

  // Stash the old positions for transition.
  nodes.forEach(function(d) {
    d.x0 = d.x
    d.y0 = d.y})
}

function query(source) {
  // Start websocket
  var websocket = new WebSocket("wss://s1.ripple.com/")
  var account = source.name
  var marker = 0
  websocket.onopen = function(e) {
    var cmd = '{"id":"1", "command":"account_info", "account":"'+account+'"}'
    websocket.send(cmd)}
  websocket.onerror = function(e) {
    source.value = JSON.parse(e.data)}
  websocket.onmessage = function(e) {
    var data = JSON.parse(e.data)
    if (data.status == "error") {
      source.value = data.error
      return}
    console.log(data);
    if(data.id==1) {
      var account_data = data.result.account_data
      var ledger = account_data.PreviousTxnLgrSeq
      source.value = comma(parseFloat(account_data.Balance/1000000).toFixed(0))
      console.log(source.value)
      source.updated = true
      var cmd = '{"id":"2", "command":"account_tx", "account":"'+account+
                '", "ledger_index_max":"'+ledger+'", "limit": "200"}'
      websocket.send(cmd)
      update(source)}      
    else {
      var result = data.result
      if (data.result.marker) {
        marker === result.marker.ledger ? 
        marker = result.marker.ledger - 1 : 
        marker = result.marker.ledger;
        websocket.send({"id":"2", "command":"account_tx", "account":account,
        "ledger_index_max": JSON.stringify(marker), "limit": "200"})}
      else websocket.close()
      var children = []
      for (var i in result.transactions) {
        var transaction = result.transactions[i];
        var type = transaction.tx.TransactionType;    
        if(type==="Payment") {
          var tx = transaction.tx
          var sender = tx.Account
          var receiver = tx.Destination
          if(sender===account && receiver!==account && !tx.Amount.currency) {
            if(isChild(account,source)) var link_value = tx.Amount/1000000
            else {
              var n = {name:account, updated:false}
              children.push(n)
              console.log(children)
              source.children = children
              var link_value = tx.Amount/1000000}
            update(source)}}}}}
}
function comma(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");}
function isChild(name, node) {
  for(i in node.children) if(node.children[i].name===name) return true
  return false
}
function toggle(d) {
  if (d.children) {
    d._children = d.children
    d.children = null
  } else {
    d.children = d._children
    d._children = null
  }
}
</script>
</body>
