<head>
<style type="text/css">
  circle {
    cursor: pointer;
    fill: #fff;
    stroke: steelblue;
    stroke-width: 1.5px;
  }

  text { font: 14px sans-serif; }

  .link {
    fill: none;
    stroke: #ccc;
    stroke-width: 1.5px;
  }

  .account { fill: grey;}
</style>
</head>

<body>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript">
var m_left = 280
var m_top = 20
var w = screen.availWidth - m_left
var h = screen.availHeight - m_top

var svg = d3.select("body")
    .append("svg")
    .attr("width", w + m_left)
    .attr("height", h + m_top)
    .append("svg:g")
    .attr("transform", "translate(" + m_left + "," + m_top + ")");
var tree = d3.layout.tree()
    .size([h,w])
var diagonal = d3.svg.diagonal()
    .projection(function(d) {return [d.y, d.x]})
var link_value = []

var data = [{id:0, name:"rJYMACXJd1eejwzZA53VncYmiK2kZSBxyD", updated:false}]
var root = data[0]
var nodes

var radius = 5
var duration = 500

update()

function update() {
  // Update nodes
  nodes = tree.nodes(root)
  nodes.forEach(function(d) {d.y = d.depth * m_left})
  
  // Enter new nodes
  var node = svg.selectAll("g.node")
      .data(nodes)
  var nodeEnter = node.enter()
      .append("svg:g")
      .attr("class", "node")
      .attr("transform", function(d) {return "translate("+d.y+","+d.x+")"})
      .on("click", function(d) {if(!d.updated) query(d)})
  nodeEnter.append("circle")
      .attr("r",1e-6)
  nodeEnter.append("text")
      .attr("class","account")
      .style("fill-opacity", 1e-6)
  nodeEnter.append("text")
      .text(function(d) {return d.value})
      .attr("class","value")      
      .style("fill-opacity", 1e-6)

  // Transition nodes to their new position.
  var nodeUpdate = node.transition()
      .duration(duration)
      .attr("transform", function(d) {return "translate("+d.y+","+d.x+")"})
  nodeUpdate.select("circle")
      .attr("r", radius)
      .style("fill", function(d) {return d._children || d._children ? "lightsteelblue" : "#fff"})
  nodeUpdate.select("text.account")
    .text(function(d) {return d.name})
    .attr("dy", ".35em")
    .attr("x", function(d) {return radius*2*(d.children?-1:1)})
    .attr("text-anchor", function(d) {return d.children ? "end" : "start"})
    //.attr("y", -radius*2)
    //.attr("text-anchor", "middle")    
    .style("fill-opacity", 1)
  nodeUpdate.select("text.value")
    .text(function(d) {return comma(d.value)})
    .attr("y", radius*5)
    .attr("text-anchor", "middle")
    .style("fill-opacity", 1)

  // Transition exiting nodes to the parent's new position.
  var nodeExit = node.exit().transition()
      .duration(duration)
      .attr("transform", function(d) {return "translate(" + source.y + "," + source.x + ")"})
      .remove()
  nodeExit.select("circle")
      .attr("r", 1e-6)
  nodeExit.selectAll("text")
      .style("fill-opacity", 1e-6)

  // Update links
  var links = tree.links(nodes)
  var link = svg.selectAll("path.link")
      .data(links, function(d) {return d.target.id})
  link.enter()
      .insert("path", "g")
      .attr("id", function(d) {return d.target.id})
      .attr("class", "link")
      .attr("d", function(d) {
        var o = {x: d.x, y: d.y}
        return diagonal({source: o, target: o})})

  // Transition links to their new position.
  link.transition()
      .duration(duration)
      .attr("d", diagonal)

  var textPath = svg.selectAll("textPath")
      .data(link_value)
      .enter()
      .append("text")
      .attr("dx",m_left/2)
      .attr("dy",-radius)    
      .append("textPath")
      .attr("xlink:href", function(d) {return '#' + d.id })
      .text(function(d) {return comma(d.value)})
      .attr("class", "account")
  
}

function query(source) {
  // Start websocket
  var websocket = new WebSocket("wss://s1.ripple.com/")
  var account = source.name
  var marker = 0
  var len = nodes.length
  source.value = "Checking..."
  update()  
  websocket.onopen = function(e) {
    var cmd = '{"id":"1", "command":"account_info", "account":"'+account+'"}'
    websocket.send(cmd)}
  websocket.onclose = function(e) {console.log("closed");update()}
  websocket.onerror = function(e) {console.log(JSON.parse(e.data));source.value = "error";websocket.close()}
  websocket.onmessage = function(e) {
    var data = JSON.parse(e.data)    
    if (data.status == "error") {
      source.value = data.error
      console.log(data.error)
      websocket.close()
      return}    
    if(data.id==1) {
      var account_data = data.result.account_data
      var ledger = account_data.PreviousTxnLgrSeq
      source.value = xrp(account_data.Balance)
      update()
      source.updated = true
      var cmd = cmdAccountTx(2,"account_tx",account,ledger,200)
      websocket.send(cmd)}      
    else {
      var result = data.result
      //console.log(result)
      if (result.marker) {
        marker === result.marker.ledger ? 
        marker = result.marker.ledger - 1 : 
        marker = result.marker.ledger;
        websocket.send(cmdAccountTx(2,"account_tx",account,marker,200))}
      else websocket.close()      
      for (var i in result.transactions) {
        var transaction = result.transactions[i];
        var type = transaction.tx.TransactionType;    
        if(type==="Payment") {
          var tx = transaction.tx
          var sender = tx.Account
          var receiver = tx.Destination
          if(sender===account && receiver!==account && !tx.Amount.currency) {
            var id = childID(receiver,source.children)
            var value = xrp(tx.Amount)
            if(id>=0) {              
              link_value.map(function(l) {
                if(l.id===id) l.value += +value})}
            else {
              id = len++
              console.log("id:"+id)
              var n = {id:id, name:receiver, updated:false}
              var l = {id:id, value:+value}
              if(source.children) source.children.push(n)
              else source.children = [n]
              link_value.push(l)}
            console.log(sender,receiver,comma(value))}}}
      update()}}
}
function xrp(amount) {
  return parseFloat(amount/1000000).toFixed(0)}
function comma(x) {
  return x ? x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : ""}
function childID(name, nodes) {
  for(c in nodes) {
    if(nodes[c].name===name) return nodes[c].id}
  return -1
}
function cmdAccountTx(id, cmd, account, ledger, limit) {
  return JSON.stringify({
      id: id, command: cmd, account: account,
      ledger_index_max: ledger, limit: limit })
}

</script>
</body>